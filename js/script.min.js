document.addEventListener("DOMContentLoaded",function(){const e=document.querySelector(".reservation-form");e&&e.addEventListener("submit",function(e){e.preventDefault();const t=document.getElementById("pickup_date"),o=document.getElementById("return_date"),s=document.getElementById("vehicle_type");let a=!0;t.value?r(t,"pickup_date_error"):(n(t,"pickup_date_error"),a=!1),o.value?t.value&&o.value<=t.value?(n(o,"return_date_error"),a=!1):r(o,"return_date_error"):(n(o,"return_date_error"),a=!1),s.value?r(s,"vehicle_type_error"):(n(s,"vehicle_type_error"),a=!1),a&&alert("Formulario válido. Buscando vehículos disponibles...")});const t=document.getElementById("loginForm");function n(e,t){e.classList.add("is-invalid"),e.setAttribute("aria-invalid","true");const n=document.getElementById(t);n&&(n.style.display="block"),document.querySelector(".is-invalid:focus")||e.focus()}function r(e,t){e.classList.remove("is-invalid"),e.setAttribute("aria-invalid","false");const n=document.getElementById(t);n&&(n.style.display="none")}t&&t.addEventListener("submit",function(e){e.preventDefault();const t=document.getElementById("loginEmail"),o=document.getElementById("loginPassword"),s=document.getElementById("login_general_error");let a=!0;t.value&&/^[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$/i.test(t.value)?r(t,"loginEmail_error"):(n(t,"loginEmail_error"),a=!1),o.value?o.value.length<6?(n(o,"loginPassword_error"),a=!1):r(o,"loginPassword_error"):(n(o,"loginPassword_error"),a=!1),a&&(s.classList.add("d-none"),alert("Formulario válido. Iniciando sesión..."))});document.querySelectorAll("input[required], select[required]").forEach(e=>{e.addEventListener("blur",function(){if(this.classList.contains("is-invalid")){if(this.closest("form")){const e=this.getAttribute("aria-describedby")?.split(" ")[0];this.checkValidity()&&r(this,e)}}})});const o=document.querySelectorAll('.navbar-nav .nav-link[href^="#"]'),s=document.querySelectorAll("section[id]");function a(){let e="";s.forEach(t=>{const n=t.offsetTop;t.clientHeight;pageYOffset>=n-150&&(e=t.getAttribute("id"))}),o.forEach(t=>{t.classList.remove("active"),t.hasAttribute("aria-current")&&t.removeAttribute("aria-current"),t.getAttribute("href")==="#"+e&&(t.classList.add("active"),t.setAttribute("aria-current","page"))})}window.addEventListener("scroll",a),o.forEach(e=>{e.addEventListener("click",function(){const e=document.querySelector(".navbar-collapse");if(e.classList.contains("show")){new bootstrap.Collapse(e).hide()}})}),a()});const observerOptions={threshold:.1,rootMargin:"0px 0px -50px 0px"},observer=new IntersectionObserver(function(e){e.forEach(e=>{e.isIntersecting&&e.target.classList.add("fade-in")})},observerOptions);document.addEventListener("DOMContentLoaded",function(){document.querySelectorAll(".vehicle-card, .branch-card, .pricing-card").forEach(e=>{observer.observe(e)})}),document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("loginForm");if(!e)return;e.addEventListener("submit",async function(e){e.preventDefault();const t=document.getElementById("loginEmail").value.trim(),n=document.getElementById("loginPassword").value;if(t&&n)try{const o=await fetch("/api/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:t,password:n})});if(!o.ok){const e=await o.json().catch(()=>({}));return void alert(e.error||"Error al iniciar sesión")}const s=await o.json();sessionStorage.setItem("auth",JSON.stringify({token:s.token,user:s.user}));const a=document.getElementById("loginModal");if(a){bootstrap.Modal.getOrCreateInstance(a).hide()}r();try{const e=s.user&&s.user.rol?s.user.rol:"cliente";window.location.href="admin"===e?"/pages/admin.html":"/pages/user.html"}catch(e){window.location.href="/pages/dashboard.html"}}catch(e){console.error("Login error",e),alert("Error intentando iniciar sesión")}else alert("Por favor completa email y contraseña")});const t=document.getElementById("btnSignOut");t&&t.addEventListener("click",async function(){sessionStorage.removeItem("auth"),r();try{await fetch("/api/logout",{method:"POST"})}catch(e){}});const n=document.getElementById("btnMyReservations");function r(){const e=JSON.parse(sessionStorage.getItem("auth")||"null"),t=document.getElementById("btnMyReservations"),n=document.getElementById("btnSignOut"),r=document.querySelectorAll('[data-bs-target="#loginModal"], #loginModal');e&&e.user?(t&&t.classList.remove("d-none"),n&&n.classList.remove("d-none"),r.forEach(e=>e.classList&&e.classList.add("d-none"))):(t&&t.classList.add("d-none"),n&&n.classList.add("d-none"),r.forEach(e=>e.classList&&e.classList.remove("d-none")))}n&&n.addEventListener("click",async function(){const e=JSON.parse(sessionStorage.getItem("auth")||"null");if(!e||!e.user)return void alert("Debes iniciar sesión para ver tus reservas");const t=document.getElementById("reservationsModal");bootstrap.Modal.getOrCreateInstance(t).show();const n=document.getElementById("reservationsList");n.innerHTML='<p class="text-muted">Cargando reservas...</p>';try{const t=await fetch(`/api/reservations?user_id=${encodeURIComponent(e.user.id)}`,{headers:{Authorization:"Bearer "+e.token}});if(!t.ok)throw new Error("Error cargando reservas");const r=await t.json();if(!r.length)return void(n.innerHTML='<p class="text-muted">No tienes reservas.</p>');const o=r.map(e=>`\n                    <div class="card mb-2">\n                      <div class="card-body">\n                        <h6 class="card-title">Reserva #${e.id} — ${e.vehicle_type}</h6>\n                        <p class="card-text small text-muted">${e.pickup_date} → ${e.return_date} · ${e.status}</p>\n                        <p class="mb-0">Precio: ${e.price||"-"} </p>\n                      </div>\n                    </div>\n                `).join("");n.innerHTML=o}catch(e){console.error(e),n.innerHTML='<p class="text-danger">Error cargando reservas.</p>'}}),r()});