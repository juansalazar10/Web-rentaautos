<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Admin Dashboard - RentaAutos</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Admin dashboard styles -->
    <link rel="stylesheet" href="../css/admin-dashboard.css" />
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-success">
      <div class="container d-flex align-items-center">
        <a class="navbar-brand me-3" href="/">RentaAutos</a>
        <div class="navbar-text text-white d-none d-lg-block">
          Panel de administración
        </div>

        <div class="ms-auto d-flex align-items-center gap-3">
          <!-- compact quick stats (optional) -->
          <div
            class="d-none d-md-flex text-white muted-small align-items-center"
          >
            <i class="fas fa-chart-line me-2"></i>
            <span id="navbarStats">—</span>
          </div>

          <!-- user dropdown -->
          <div class="dropdown">
            <button
              class="btn btn-sm btn-light d-flex align-items-center"
              id="userMenuButton"
              data-bs-toggle="dropdown"
              aria-expanded="false"
            >
              <div
                class="avatar-sm bg-white rounded-circle d-flex align-items-center justify-content-center me-2"
                style="width: 34px; height: 34px"
              >
                <i class="fas fa-user-shield text-success"></i>
              </div>
              <div class="d-none d-sm-block text-start me-1">
                <div id="adminNameNav" class="fw-600 small text-dark">
                  Administrador
                </div>
                <div
                  id="adminEmailNav"
                  class="muted-small"
                  style="line-height: 1"
                >
                  admin@rentacar.com
                </div>
              </div>
              <i class="fas fa-caret-down ms-2 d-none d-sm-block text-dark"></i>
            </button>
            <ul
              class="dropdown-menu dropdown-menu-end"
              aria-labelledby="userMenuButton"
            >
              <li><a class="dropdown-item" href="#">Perfil</a></li>
              <li><hr class="dropdown-divider" /></li>
              <li>
                <a id="btnLogout" class="dropdown-item text-danger" href="#"
                  >Cerrar sesión</a
                >
              </li>
            </ul>
          </div>
        </div>
      </div>
    </nav>

    <main class="container py-4">
      <div class="row">
        <!-- Sidebar -->
        <aside class="col-lg-3 mb-4">
          <div class="card sidebar-card p-3">
            <div class="d-flex align-items-center mb-3">
              <div
                class="avatar me-3 bg-white shadow-sm rounded-circle d-flex align-items-center justify-content-center"
                style="width: 56px; height: 56px"
              >
                <i class="fas fa-user-shield text-success"></i>
              </div>
              <div>
                <div id="adminName" class="fw-600">Administrador</div>
                <div class="muted-small">Panel de control</div>
              </div>
            </div>
            <nav class="mt-3">
              <ul class="list-unstyled">
                <li class="mb-2">
                  <a
                    href="#users"
                    class="d-block py-2 px-2 rounded nav-link-admin"
                    ><i class="fas fa-users me-2"></i>Usuarios</a
                  >
                </li>
                <li class="mb-2">
                  <a
                    href="#reservas"
                    class="d-block py-2 px-2 rounded nav-link-admin"
                    ><i class="fas fa-calendar-check me-2"></i>Reservas</a
                  >
                </li>
                <li class="mb-2">
                  <a
                    href="#reports"
                    class="d-block py-2 px-2 rounded nav-link-admin"
                    ><i class="fas fa-chart-line me-2"></i>Reportes</a
                  >
                </li>
                <li class="mb-2">
                  <a
                    href="#settings"
                    class="d-block py-2 px-2 rounded nav-link-admin"
                    ><i class="fas fa-cog me-2"></i>Configuración</a
                  >
                </li>
              </ul>
            </nav>
            <hr />
            <div>
              <button
                id="btnExportUsers"
                class="btn btn-sm btn-outline-success w-100 mb-2"
              >
                Exportar usuarios
              </button>
              <a
                href="/pages/dashboard.html"
                class="btn btn-sm btn-outline-success w-100"
                >Ver reservas</a
              >
            </div>
          </div>
        </aside>

        <!-- Main content -->
        <section class="col-lg-9">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
              <h1 class="h3 mb-0">Panel de administración</h1>
              <small id="adminInfo" class="text-muted">Resumen y gestión</small>
            </div>
            <div class="d-flex align-items-center gap-2">
              <input
                id="searchUsers"
                class="form-control form-control-sm"
                type="search"
                placeholder="Buscar usuarios (nombre o email)"
                style="min-width: 260px"
              />
              <button id="btnLogoutTop" class="btn btn-sm btn-outline-light">
                Cerrar sesión
              </button>
            </div>
          </div>

          <section id="users">
            <h2 class="h5">Usuarios</h2>
            <p class="text-muted">
              Lista de usuarios registrados (lectura y filtros rápidos).
            </p>
            <div id="usersWrap" class="card p-3">
              <div id="usersList">Cargando usuarios...</div>
              <div
                class="d-flex justify-content-between align-items-center mt-3"
              >
                <div id="usersCount" class="muted-small"></div>
                <nav>
                  <ul
                    id="pagination"
                    class="pagination pagination-sm mb-0"
                  ></ul>
                </nav>
              </div>
            </div>
          </section>

          <section id="reservas" class="mt-4">
            <h2 class="h5">Reservas recientes</h2>
            <p class="text-muted">
              Vista rápida de las reservas más recientes.
            </p>
            <div id="reservasList" class="card p-3">Cargando...</div>
          </section>
        </section>
      </div>
    </main>

    <script>
      (function () {
        const auth = JSON.parse(sessionStorage.getItem("auth") || "null");
        if (!auth || !auth.user || auth.user.rol !== "admin") {
          window.location.href = "/";
          return;
        }

        document.getElementById(
          "adminInfo"
        ).innerText = `${auth.user.nombre} · ${auth.user.email}`;
        // fill header/sidebar names
        const navNameEl = document.getElementById("adminNameNav");
        const navEmailEl = document.getElementById("adminEmailNav");
        const sideNameEl = document.getElementById("adminName");
        if (navNameEl) navNameEl.innerText = auth.user.nombre;
        if (navEmailEl) navEmailEl.innerText = auth.user.email;
        if (sideNameEl) sideNameEl.innerText = auth.user.nombre;
        // small stat placeholder
        const statsEl = document.getElementById("navbarStats");
        if (statsEl) statsEl.innerText = "—";

        const usersList = document.getElementById("usersList");
        fetch("/api/usuarios", {
          headers: { Authorization: "Bearer " + auth.token },
        })
          .then((r) => r.json())
          .then((rows) => {
            if (!Array.isArray(rows)) throw new Error("Invalid users response");
            if (!rows.length)
              return (usersList.innerHTML =
                '<p class="text-muted">No hay usuarios.</p>');

            // keep a copy for client-side filtering / pagination
            window._adminUsers = rows.map((u) => ({
              id: u.id,
              nombre: u.nombre,
              email: u.email,
              fecha_registro: u.fecha_registro,
            }));
            // initially no filter
            window._filteredUsers = window._adminUsers;
            renderUsersTable(window._filteredUsers, 1);
            // update small stat with total users
            if (statsEl) statsEl.innerText = `${rows.length} usuarios`;
          })
          .catch((err) => {
            console.error(err);
            usersList.innerHTML =
              '<p class="text-danger">Error cargando usuarios.</p>';
          });

        // navbar logout
        document.getElementById("btnLogout").addEventListener("click", () => {
          sessionStorage.removeItem("auth");
          window.location.href = "/";
        });

        // export button (placeholder)
        document
          .getElementById("btnExportUsers")
          .addEventListener("click", () => {
            alert("Funcionalidad de exportar pendiente de implementar.");
          });

        // --- client-side helpers: render, search, pagination ---
        const ROWS_PER_PAGE = 6;
        function renderUsersTable(data, page = 1) {
          const start = (page - 1) * ROWS_PER_PAGE;
          const pageRows = (data || []).slice(start, start + ROWS_PER_PAGE);
          const table = document.createElement("table");
          table.className = "table table-hover";
          table.innerHTML = `\n            <thead><tr><th>ID</th><th>Nombre</th><th>Email</th><th>Fecha registro</th></tr></thead>\n            <tbody>${pageRows
            .map(
              (u) =>
                `<tr><td>${u.id}</td><td>${u.nombre}</td><td>${u.email}</td><td>${u.fecha_registro}</td></tr>`
            )
            .join("")}</tbody>\n          `;
          usersList.innerHTML = "";
          usersList.appendChild(table);
          document.getElementById("usersCount").innerText = `${
            (data || []).length
          } usuarios`;
          renderPagination(
            Math.ceil((data || []).length / ROWS_PER_PAGE),
            page
          );
        }

        function renderPagination(totalPages, current) {
          const ul = document.getElementById("pagination");
          ul.innerHTML = "";
          if (totalPages <= 1) return;
          for (let i = 1; i <= totalPages; i++) {
            const li = document.createElement("li");
            li.className = "page-item " + (i === current ? "active" : "");
            li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
            li.addEventListener("click", (e) => {
              e.preventDefault();
              renderUsersTable(window._filteredUsers || window._adminUsers, i);
            });
            ul.appendChild(li);
          }
        }

        document
          .getElementById("searchUsers")
          .addEventListener("input", function (e) {
            const q = (e.target.value || "").toLowerCase().trim();
            window._filteredUsers = (window._adminUsers || []).filter((u) =>
              (u.nombre + " " + u.email).toLowerCase().includes(q)
            );
            renderUsersTable(window._filteredUsers, 1);
          });

        // top logout button
        document
          .getElementById("btnLogoutTop")
          .addEventListener("click", () => {
            sessionStorage.removeItem("auth");
            window.location.href = "/";
          });
      })();
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
